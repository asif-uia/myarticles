#!/usr/bin/env puma

directory '<%= current_path %>'
environment '<%= fetch(:rails_env) %>'

pidfile '<%= fetch(:puma_pid) %>'
state_path '<%= fetch(:puma_state) %>'
stdout_redirect '<%= fetch(:puma_access_log) %>', '<%= fetch(:puma_error_log) %>', true

daemonize

threads <%= fetch(:puma_threads).join(', ') %>

bind '<%= fetch(:puma_bind) %>'

activate_control_app '<%= fetch(:puma_default_control_app) %>'

workers '<%= fetch(:puma_workers) %>'

preload_app!

on_worker_boot do
  require "active_record"
  ActiveRecord::Base.connection.disconnect! rescue ActiveRecord::ConnectionNotEstablished
  ActiveRecord::Base.establish_connection(YAML.load_file('<%=shared_path%>/config/database.yml')['<%= fetch(:rails_env) %>'])
end

# Allow puma to be restarted by `rails restart` command.
plugin :tmp_restart